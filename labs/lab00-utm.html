<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Using UTM on M-series Mac laptops</title>
  <style>
html {
line-height: 1.5;
font-family: sans-serif;
font-size: 12pt;
color: black;
background-color: white;
}
body {
margin: 0 auto;
max-width: 50em;
padding-left: 50px;
padding-right: 50px;
padding-top: 50px;
padding-bottom: 50px;
hyphens: auto;
overflow-wrap: break-word;
text-rendering: optimizeLegibility;
font-kerning: normal;
}
@media (max-width: 600px) {
body {
font-size: 0.9em;
padding: 1em;
}
h1 {
font-size: 1.8em;
}
}
@media print {
body {
background-color: transparent;
color: black;
font-size: 12pt;
}
p, h2, h3 {
orphans: 3;
widows: 3;
}
h2, h3, h4 {
page-break-after: avoid;
}
}
p {
margin: 1em 0;
}
img {
max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
margin-top: 1.4em;
}
h5, h6 {
font-size: 1em;
font-style: italic;
}
h6 {
font-weight: normal;
}
ol, ul {
padding-left: 1.7em;
margin-top: 1em;
}
li > ol, li > ul {
margin-top: 0;
}
blockquote {
margin: 1em 0 1em 1.7em;
padding-left: 1em;
border-left: 2px solid #e6e6e6;
color: #606060;
}
code {
font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
background-color: hsl(0, 0%, 98%);
padding: .2em .4em;
font-size: 85%;
margin: 0;
}
pre {
margin: 1em 0;
background-color: hsl(0, 0%, 98%);
padding: 1em;
overflow: auto;
}
pre code {
padding: 0;
overflow: visible;
overflow-wrap: normal;
}

:not(pre) > code {
padding: 2px 4px;
font-size: 90%;
word-break: normal !important;
white-space: nowrap;
color: hsl(344.8,69%,10%);
background-color: hsl(342.9,37%,96%);
border-radius: 4px;
}
.sourceCode {
background-color: hsl(0, 0%, 98%);
overflow: visible;
}
hr {
background-color: #1a1a1a;
border: none;
height: 1px;
margin: 1em 0;
}
table {
margin: 1em 0;
border-collapse: collapse;
width: 100%;
overflow-x: auto;
display: block;
font-variant-numeric: lining-nums tabular-nums;
}
table caption {
margin-bottom: 0.75em;
}
tbody {
margin-top: 0.5em;
border-top: 1px solid black;
border-bottom: 1px solid black;
}
th {
border-top: 1px solid black;
padding: 0.25em 0.5em 0.25em 0.5em;
}
td {
padding: 0.125em 0.5em 0.25em 0.5em;
}
header {
margin-bottom: 4em;
text-align: center;
}
#TOC li {
list-style: none;
}
#TOC ul {
padding-left: 1.3em;
}
#TOC > ul {
padding-left: 0;
}
#TOC a:not(:hover) {
text-decoration: none;
}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>
  <style>
div#agreement img {
border: solid 0.5pt hsl(0 0% 80% / 0.5);
}
</style>
<script data-external="1" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript">
</script>
</head>
<body>
<header id="title-block-header">
<h1 class="title"><p>Using UTM on M-series Mac laptops</p></h1>
</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Contents</h2>
<ul>
<li><a href="#installing-utm" id="toc-installing-utm">1. Installing
UTM</a></li>
<li><a href="#selecting-a-virtual-machine" id="toc-selecting-a-virtual-machine">2. Selecting a virtual
machine</a></li>
<li><a href="#notes-on-the-arm64-platform" id="toc-notes-on-the-arm64-platform">3. Notes on the ARM64 platform</a>
<ul>
<li><a href="#differences" id="toc-differences">3.1 What are some
differences between ARM64 vs x86-64 platforms?</a></li>
<li><a href="#what-platform-will-submitted-projects-be-tested-on" id="toc-what-platform-will-submitted-projects-be-tested-on">3.2 What
platform will submitted projects be tested on?</a></li>
<li><a href="#project-requirements" id="toc-project-requirements">3.3
How can I ensure my code runs correctly on the x86-64 platform?</a></li>
</ul></li>
</ul>
</nav>
<h2 id="installing-utm">1. Installing UTM</h2>
<p>Visit <a href="https://mac.getutm.app/" class="uri">https://mac.getutm.app/</a>, then click “Download”.
(Downloading from the UTM website is more reliable than following the
“Mac App Store” link.)</p>
<p>Once downloaded, locate and select the .dmg file you have downloaded.
A dialog box should appear. Click and drag the icon to your Applications
folder.</p>
<h2 id="selecting-a-virtual-machine">2. Selecting a virtual machine</h2>
<p>You’ll need to download one or more virtual machine images, and then
create virtual machines from them that you’ll use as a development
environment. (You can download more than one, and you can delete any
downloaded image if you like and try again.)</p>
<p>There are many options for downloading a virtual machine image – we
outline three possibilities.</p>
<div style="margin-left: 1rem; border: solid 2pt blue; background-color: hsla(241, 100%,50%, 0.1); padding: 1em; border-radius: 5pt; margin-top: 1em; margin-bottom: 1em">
<dl>
<dt><strong>Use an ARM64 image</strong></dt>
<dd>
<p>The <a href="https://mac.getutm.app/gallery/">“gallery” of pre-built
UTM virtual machines</a> doesn’t include any for Ubuntu 20.04, but it
<em>does</em> include one for Ubuntu 22.04, which is very similar. You
can visit <a href="https://mac.getutm.app/gallery/ubuntu-20-04">this
link</a> to download the Ubuntu 22.04 image. Clicking the “Open in UTM”
link should download the virtual machine image and open it using
UTM.</p>
<p>This image uses an <a href="https://en.wikipedia.org/wiki/ARM64">ARM64 processor</a>, so it is
<em>not</em> the same as the CITS3007 standard development environment
(SDE) – see <a href="#differences">here</a> for some of the differences.
For most purposes, the virtual machine you’ve downloaded should behave
quite similarly to the CITS3007 SDE, but:</p>
<ul>
<li>when you get to lab 4 (in week 5), which covers buffer overflows: if
you want to attempt the extension tasks for the lab, they <em>won’t</em>
work on an ARM64 virtual machine. They use <a href="https://en.wikipedia.org/wiki/Shellcode">shellcode</a> that only
works on x86-64 processors.</li>
<li>when working on the project (due in week 11), you’ll need to allow
for differences between platforms. The biggest difference is that the
<code>char</code> type on an x86-64 platform is <em>signed</em>, but on
ARM64 platforms it is <em>unsigned</em>. You may want to make use of
GCC’s <code>-fsigned-char</code> option to mimic the x86-64 behaviour
(see <a href="#differences">here</a>). It’s also recommended that you
test your code using a x86-64 virtual machine before submitting.</li>
</ul>
</dd>
</dl>
</div>
<div style="margin-left: 1rem; border: solid 2pt blue; background-color: hsla(241, 100%,50%, 0.1); padding: 1em; border-radius: 5pt; margin-top: 1em; margin-bottom: 1em">
<dl>
<dt><strong>Use an old x86-64 image</strong></dt>
<dd>
<p>The <a href="https://mac.getutm.app/gallery/">“gallery” of pre-built
UTM virtual machines</a> includes an image for a very old (2013) version
of Ubuntu 14.04, which you should be able to use in order to test code
on an x86-64 platform. However, x86-64 images run <em>much</em> more
slowly than ARM64 images do – your Mac has to emulate a very different
sort of CPU.</p>
<p>You can visit <a href="https://mac.getutm.app/gallery/ubuntu-14-04">this link</a> to
download the Ubuntu 14.04 image. Clicking the “Open in UTM” link should
download the virtual machine image and open it using UTM.</p>
</dd>
</dl>
</div>
<p>Another possibility, although it has not been very thoroughly tested,
is to use UTM with a CITS3007 x86-64 <a href="https://en.wikipedia.org/wiki/Qcow">Qcow</a> image file.</p>
<div style="margin-left: 1rem; border: solid 2pt blue; background-color: hsla(241, 100%,50%, 0.1); padding: 1em; border-radius: 5pt; margin-top: 1em; margin-bottom: 1em">
<dl>
<dt><strong>Use the CITS3007 x86-64 Qcow image file</strong></dt>
<dd>
<p>A Qcow image file – a format related to the one UTM uses – is
available for the x86-64 CITS3007 standard development environment
(SDE). However, UTM doesn’t provide very clear documentation on how such
files can be used. Nevertheless, if you wish to try it, and are familiar
with the Linux command line, some general instructions are:</p>
<ul>
<li>Download the Vagrant <code>.box</code> file from <a href="https://app.vagrantup.com/arranstewart/boxes/cits3007-ubuntu2004/versions/0.1.4/providers/libvirt/unknown/vagrant.box">here</a>
to your machine (the saved file should be called
<code>vagrant.box</code>).</li>
<li>Extract the file <code>box.img</code> from the
<code>vagrant.box</code> file using <code>tar</code>
(<code>vagrant.box</code> is a standard gzipped tar file).</li>
<li>Rename <code>box.img</code> to <code>cits3007.qcow2</code>.</li>
<li><a href="https://man.ilayk.com/gist/utm/">Import the qcow2</a> file
into UTM.</li>
</ul>
<p>To log in, use the username and password “vagrant”.</p>
</dd>
</dl>
</div>
<p>A former CITS3007 student has also provided some tips on working with
UTM <a href="/labs/Installing_cits3007_VM_via_UTM_for_mac_computers_with_ARM_based_architecture.pdf">here</a>
(PDF).</p>
<p>In the following section of this lab sheet, we discuss some ways that
an ARM64 platform can differ from the x86-64 platform.</p>
<h2 id="notes-on-the-arm64-platform">3. Notes on the ARM64 platform</h2>
<h3 id="differences">3.1 What are some differences between ARM64 vs
x86-64 platforms?</h3>
<p>The standard <a href="https://cits3007.arranstewart.io/faq/#cits3007-sde">CITS3007
development environment</a> runs on the x86-64 architecture, and any
code you submit for the CITS3007 project will be compiled and tested
using GCC on the x86-64 architecture.</p>
<p><a href="https://en.wikipedia.org/wiki/Apple_silicon#M_series">M-series</a>
Mac laptops, however, use the <a href="https://en.wikipedia.org/wiki/ARM64">ARM64</a> architecture, which
differs from x86-64 in several ways (note that the following list is
<strong>not</strong> comprehensive!):</p>
<ul>
<li>The architectures have a different <a href="https://en.wikipedia.org/wiki/Instruction_set_architecture">instruction
set</a> – programs compiled for one will not run on the other, and <a href="https://en.wikipedia.org/wiki/Shellcode">shellcode</a> written for
one will not work on the other.</li>
<li>The <code>char</code> type can be either signed or unsigned – on the
x86-64 platform, a <code>char</code> is usually signed, but when
targeting the ARM64 architecture, C compilers (including GCC) usually
default to it being unsigned (for <a href="https://www.drdobbs.com/architecture-and-design/portability-the-arm-processor/184405435">performance
reasons</a> that are now largely historical).<br />
    It’s possible to force GCC to make the <code>char</code> type signed
or unsigned by using the <a href="https://gcc.gnu.org/onlinedocs/gcc-4.8.0/gcc/C-Dialect-Options.html"><code>-funsigned-char</code>
and <code>-fsigned-char</code></a> options.</li>
<li><a href="https://en.wikipedia.org/wiki/Data_structure_alignment">Data
structure padding and alignment</a> can <a href="https://www.drdobbs.com/architecture-and-design/portability-the-arm-processor/184405435">differ</a>
between the two. GCC provides <a href="https://gcc.gnu.org/onlinedocs/gcc-4.4.7/gcc/Variable-Attributes.html">“attributes”</a>
which allow you to force variables or structs to use padding and
alignment rules you specify. (Doing this can result in generated code
being slightly slower, but you may not care about the difference.)</li>
</ul>
<p>You can find comments on some of these differences in the <a href="https://developer.arm.com/documentation/den0013/d/Porting/Miscellaneous-C-porting-issues">“Miscellaneous
C porting issues”</a> section of the developer documentation for the
ARMv7-A series of processors.</p>
<h3 id="what-platform-will-submitted-projects-be-tested-on">3.2 What
platform will submitted projects be tested on?</h3>
<p>Projects will be tested on the x86-64 platform, using GCC as a
compiler, and the <a href="https://cits3007.arranstewart.io/faq/#cits3007-sde">CITS3007
standard development environment</a>.</p>
<h3 id="project-requirements">3.3 How can I ensure my code runs
correctly on the x86-64 platform?</h3>
<p>It’s up to you to make sure that you thoroughly test your code and
ensure it runs correctly on the x86-64 platform. Some suggestions as to
how you might do so include:</p>
<ul>
<li>Compiling and testing your code using a pre-built <a href="https://mac.getutm.app/gallery/">UTM virtual machine</a> which
emulates the x86-64 processor. (An example is the pre-built <a href="https://mac.getutm.app/gallery/ubuntu-14-04">Ubuntu 14.04</a>
virtual machine.) Note that emulated virtual machines will run quite
slowly on a Mac ARM64 computer.</li>
<li>Compiling and testing your code using a virtual machine on <a href="https://cits3007.arranstewart.io/labs/lab01-gitpod.html">GitPod</a>.
(Note that on GitPod, you won’t be able to <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_monitoring_and_updating_the_kernel/configuring-kernel-parameters-at-runtime_managing-monitoring-and-updating-the-kernel">alter
the kernel parameters</a>, which is required if you want to complete the
“extension tasks” for the week 6 lab, on buffer overflows, and for the
week 8 lab, on race conditions.)</li>
<li>Referring to published portability guidelines – one set of such
guidelines is provided by <a href="https://www.doc.ic.ac.uk/lab/cplus/cstyle.html#N10553">Imperial
College, London</a>, and the <a href="https://www.gnu.org/prep/standards/standards.html#CPU-Portability">GNU
project</a> also has some suggestions.</li>
<li>Compiling and testing on an ARM64 platform with a range of different
static analysers, a range of different compilers (e.g. both GCC and
Clang) – with all appropriate warnings enabled – with a range of
different <a href="https://github.com/google/sanitizers">sanitizers</a>
enabled, and at a range of different <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">optimization
levels</a>. While this won’t ensure your code works correctly on an
x86-64 platform, it is likely to result in fewer problems once you do
try to run it on an x86-64 system.</li>
</ul>
<!-- vim: syntax=markdown tw=90 smartindent :
-->
</body>
</html>
